# Data Loading Architecture Review

**Date**: 2026-01-03
**Priority**: High
**Status**: Analysis Complete

## Problem Statement

The way BRL, BCL, BDL data is loaded from HTML is unclear. There are concerns that:
1. Enemy data appears to be loaded from JSON, but should come from BDL via IR
2. Player-customized BCL strategies need to be recompiled and used at runtime
3. The end-to-end data flow needs clarification for future browser-based BRL/BDL editing

## Current Architecture Analysis

### Data Flow Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    COMPILE TIME (via blink-compiler)                     │
├─────────────────────────────────────────────────────────────────────────┤
│  BRL Files           BCL Files          BDL Files                        │
│  (game/brl/)         (game/bcl/)        (game/bdl/)                      │
│       │                   │                  │                           │
│       └───────────────────┴──────────────────┘                           │
│                           │                                              │
│                    ┌──────▼──────┐                                       │
│                    │  Compiler   │                                       │
│                    │  (Rust)     │                                       │
│                    └──────┬──────┘                                       │
│                           │                                              │
│                    ┌──────▼──────┐                                       │
│                    │  IR (.json) │  ← Single source of truth             │
│                    └─────────────┘                                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                    RUNTIME (in browser)                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                    ┌─────────────┐                                       │
│                    │  IR (.json) │  ← Loaded first                       │
│                    └──────┬──────┘                                       │
│                           │                                              │
│                    ┌──────▼──────┐                                       │
│                    │ BlinkEngine │                                       │
│                    │  (JS/TS)    │                                       │
│                    └─────────────┘                                       │
│                           │                                              │
│         ┌─────────────────┼─────────────────┐                           │
│         │                 │                 │                           │
│  ┌──────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐                    │
│  │   Rules     │  │   Entities   │  │   Trackers   │                    │
│  │ (from BRL)  │  │ (from BDL)   │  │ (from BRL)   │                    │
│  └─────────────┘  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────────────────────┘
```

### Current Implementation Status

#### 1. BRL (Blink Rule Language) - ✅ Correctly loaded from IR
- **Source**: `game/brl/classic-rpg.brl`
- **Compiled to**: `game/ir/classic-rpg.ir.json` (generated by compiler)
- **Runtime loading**: `rpg-demo.html` loads IR via `loadDefaultIR()` → `game.loadRulesFromObject(ir)`
- **Status**: Working correctly - rules, components, trackers all come from IR

#### 2. BDL (Blink Data Language) - ⚠️ Partial Implementation
- **Source**: `game/bdl/enemies.bdl`, `game/bdl/heroes.bdl`, `game/bdl/game-config.bdl`
- **Problem**: BDL is NOT compiled into IR yet - data loaded from separate JSON files
- **Current workaround**:
  - `enemies.bdl` → `game/data/enemies.json` (manually maintained JSON copy)
  - `heroes.bdl` → `game/data/characters.json` (manually maintained JSON copy)
  - `game-config.bdl` → Entity in IR's `initial_state` (correct)
- **Runtime loading**: 
  - `loadEnemyData()` fetches `enemies.json`
  - `loadCharacterData()` fetches `characters.json`

#### 3. BCL (Blink Choice Language) - ⚠️ Not Integrated
- **Source**: `game/bcl/party-config.bcl`, `game/bcl/*-skills.bcl`
- **Problem**: BCL is NOT compiled into IR
- **Current status**: 
  - Files exist but are not used at runtime
  - Player customizations stored in localStorage, not compiled
  - `initBclSystem()` loads choice points but they're empty (not in IR)
  - `downloadBclDelta()` exports customizations but they're not applied

### Identified Issues

#### Issue 1: Enemy Data Not in IR
The enemy templates are loaded from `enemies.json` instead of from IR.

**Expected flow**:
```
enemies.bdl → (compiler) → IR.initial_state.entities (enemy templates)
```

**Current flow**:
```
enemies.bdl → (manual copy) → enemies.json → loadEnemyData() → enemyTemplates[]
```

**Impact**: Changes to `enemies.bdl` don't automatically reflect in game.

#### Issue 2: Hero Data Not in IR
Character data is loaded from `characters.json` instead of IR.

**Expected flow**:
```
heroes.bdl → (compiler) → IR.initial_state.entities (hero definitions)
```

**Current flow**:
```
heroes.bdl → (manual copy) → characters.json → loadCharacterData() → availableCharacters[]
```

**Impact**: Changes to `heroes.bdl` don't automatically reflect in party selection.

#### Issue 3: BCL Strategies Not Compiled
Player strategy customizations are stored but not compiled/executed.

**Expected flow**:
```
party-config.bcl → (compiler) → IR.choice_functions[] 
→ Player edits in browser → BCL delta file
→ (recompile) → Updated IR with custom choices
→ Engine executes custom choice functions
```

**Current flow**:
```
Player edits choice in browser → localStorage
→ (no compilation - stored as text only)
→ downloadBclDelta() creates .bcl file (not used)
```

**Impact**: Player customizations are cosmetic only - they don't affect gameplay.

#### Issue 4: Source Map Missing from IR
The integrated IDE shows placeholder BRL source, not actual compiled source.

**Expected**: IR should include `source_map` field with original BRL/BCL/BDL source
**Current**: `loadSourceFilesFromIR()` falls back to hardcoded placeholders

## Required Changes

### Phase 1: Architecture Documentation (hielements.hie)

Update the architecture specification to clarify:
1. IR is the single source of truth at runtime
2. BDL entities must be compiled into IR.initial_state
3. BCL choice functions must be compiled into IR.choice_functions
4. Source map must be included in IR for dev tools

### Phase 2: IR Specification Updates (doc/ir-specification.md)

Add new sections to IR spec:
1. `choice_functions` - BCL choice function definitions
2. `source_map` - Original source code for debugging
3. Entity templates for dynamic spawning (enemies)

### Phase 3: Runtime Loading Changes (rpg-demo.html)

1. Load enemy templates from IR.initial_state (not enemies.json)
2. Load hero definitions from IR.initial_state (not characters.json)  
3. Load choice points from IR.choice_functions (not hardcoded)
4. Load source from IR.source_map (not placeholders)

### Phase 4: BCL Recompilation Support (Future)

Enable browser-based BCL editing and recompilation:
1. WASM-compiled BRL/BCL parser in browser
2. Delta compilation: merge base IR with BCL customizations
3. Hot-reload updated choice functions without page refresh

## Implementation Notes

### Why Not Just Load JSON Files?

The current approach of loading from JSON files works, but has problems:
1. **Sync issues**: BDL source and JSON can get out of sync
2. **No validation**: JSON isn't type-checked against BRL components
3. **No BCL execution**: Choice functions can't be executed at all
4. **Fragmented data**: Multiple files to deploy instead of single IR

### Why IR is the Right Approach

The IR (Intermediate Representation) is designed to be:
1. **Complete**: Contains all data needed for execution
2. **Validated**: Compiler ensures correctness
3. **Portable**: Single JSON file for deployment
4. **Efficient**: Pre-processed for engine consumption

### Transition Strategy

Until compiler fully supports BDL/BCL:
1. Keep JSON files as fallback
2. Add IR.source_map support (compiler enhancement)
3. Add IR.choice_functions support (compiler enhancement)
4. Add IR entity templates for enemies (compiler enhancement)
5. Deprecate JSON loading once IR is complete

## Success Criteria

1. ✅ All game data (rules, entities, trackers) comes from single IR file
2. ✅ Enemy templates loaded from IR.initial_state
3. ✅ Hero definitions loaded from IR.initial_state
4. ✅ Choice functions loaded from IR.choice_functions
5. ✅ Source code loaded from IR.source_map
6. ✅ Player BCL customizations can be compiled and used
7. ✅ No separate JSON files required at runtime

## Files to Modify

1. `hielements.hie` - Architecture documentation
2. `doc/ir-specification.md` - Add choice_functions, source_map specs
3. `game/demos/rpg-demo.html` - Load all data from IR
4. `.github/workflows/github-pages.yml` - Ensure IR is compiled with all data

## Compiler Changes Required (Future PR)

The Rust compiler needs updates to:
1. Parse BDL files and add entities to IR.initial_state
2. Parse BCL files and add functions to IR.choice_functions
3. Include original source in IR.source_map with --source-map flag
4. Handle entity templates (non-spawned entities for dynamic creation)

## Related Documents

- [IR Specification](../doc/ir-specification.md)
- [BDL Specification](../doc/language/bdl-specification.md)
- [BCL Specification](../doc/language/bcl-specification.md)
- [IR Runtime Loading](./2026-01-03-ir-runtime-loading.md)
- [BDL Implementation](./2026-01-03-bdl-implementation.md)
