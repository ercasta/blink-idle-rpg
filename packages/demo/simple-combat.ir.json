{
  "version": "1.0",
  "module": "simple_combat",
  "metadata": {
    "compiled_at": "2024-12-31T12:00:00Z",
    "compiler_version": "0.1.0"
  },
  "components": [
    {
      "id": 0,
      "name": "Character",
      "fields": [
        { "name": "name", "type": "string" },
        { "name": "level", "type": "number", "default": 1 }
      ]
    },
    {
      "id": 1,
      "name": "Health",
      "fields": [
        { "name": "current", "type": "number", "default": 100 },
        { "name": "max", "type": "number", "default": 100 }
      ]
    },
    {
      "id": 2,
      "name": "Attack",
      "fields": [
        { "name": "damage", "type": "number", "default": 10 },
        { "name": "speed", "type": "number", "default": 1.0 }
      ]
    },
    {
      "id": 3,
      "name": "Target",
      "fields": [
        { "name": "entity", "type": "entity", "default": null }
      ]
    }
  ],
  "rules": [
    {
      "id": 0,
      "name": "attack_rule",
      "trigger": {
        "type": "event",
        "event": "DoAttack",
        "bindings": {
          "attacker": "source"
        }
      },
      "filter": {
        "components": ["Attack", "Target"]
      },
      "condition": {
        "type": "binary",
        "op": "neq",
        "left": { 
          "type": "field", 
          "entity": "attacker", 
          "component": "Target", 
          "field": "entity" 
        },
        "right": { "type": "literal", "value": null }
      },
      "actions": [
        {
          "type": "modify",
          "entity": { 
            "type": "field", 
            "entity": "attacker", 
            "component": "Target", 
            "field": "entity" 
          },
          "component": "Health",
          "field": "current",
          "op": "subtract",
          "value": { 
            "type": "field", 
            "entity": "attacker", 
            "component": "Attack", 
            "field": "damage" 
          }
        },
        {
          "type": "schedule",
          "event": "DoAttack",
          "source": { "type": "var", "name": "attacker" },
          "delay": { 
            "type": "binary",
            "op": "divide",
            "left": { "type": "literal", "value": 100 },
            "right": { 
              "type": "field", 
              "entity": "attacker", 
              "component": "Attack", 
              "field": "speed" 
            }
          }
        }
      ]
    },
    {
      "id": 1,
      "name": "death_check",
      "trigger": {
        "type": "event",
        "event": "DoAttack"
      },
      "filter": {
        "components": ["Health"]
      },
      "condition": {
        "type": "binary",
        "op": "lte",
        "left": { 
          "type": "field", 
          "entity": "entity", 
          "component": "Health", 
          "field": "current" 
        },
        "right": { "type": "literal", "value": 0 }
      },
      "actions": [
        {
          "type": "emit",
          "event": "Death",
          "fields": {
            "target": { "type": "var", "name": "entity" }
          }
        }
      ]
    }
  ],
  "functions": [
    {
      "id": 0,
      "name": "calculate_damage",
      "params": [
        { "name": "base", "type": "number" },
        { "name": "multiplier", "type": "number" }
      ],
      "return_type": { "type": "number" },
      "body": {
        "type": "binary",
        "op": "multiply",
        "left": { "type": "param", "name": "base" },
        "right": { "type": "param", "name": "multiplier" }
      }
    }
  ],
  "trackers": [
    { "id": 0, "component": "Health", "event": "DoAttack" },
    { "id": 1, "component": "Character", "event": "DoAttack" },
    { "id": 2, "component": "Health", "event": "Death" }
  ],
  "initial_state": {
    "entities": [
      {
        "id": 0,
        "components": {
          "Character": { "name": "Hero", "level": 1 },
          "Health": { "current": 100, "max": 100 },
          "Attack": { "damage": 15, "speed": 1.2 },
          "Target": { "entity": 1 }
        }
      },
      {
        "id": 1,
        "components": {
          "Character": { "name": "Goblin", "level": 1 },
          "Health": { "current": 50, "max": 50 },
          "Attack": { "damage": 8, "speed": 0.8 },
          "Target": { "entity": 0 }
        }
      }
    ]
  }
}
