name: Build Demo Package (Windows)

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-demo-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Build compiler
        run: |
          Set-Location src\compiler
          cargo build --release
          Write-Host "Compiler built successfully"
          Set-Location ..\..
        shell: pwsh
      
      - name: Compile BRL to IR
        run: |
          New-Item -ItemType Directory -Path game\ir -Force
          Set-Location src\compiler
          # Build list of BCL files for inclusion in source map
          $bclIncludes = @()
          Get-ChildItem ..\..\game\bcl\*.bcl -ErrorAction SilentlyContinue | ForEach-Object {
            $bclIncludes += "--include"
            $bclIncludes += $_.FullName
          }
          # Compile all BRL files to IR with source maps for debugging support
          # Note: BDL files are only included for classic-rpg.brl since they depend on its component definitions
          Get-ChildItem ..\..\game\brl\*.brl | ForEach-Object {
            $filename = $_.BaseName
            if ($filename -eq "classic-rpg") {
              # classic-rpg.brl gets BDL files included (heroes, enemies, game-config)
              $args = @("compile", "-i", $_.FullName, "-o", "..\..\game\ir\$filename.ir.json", "--pretty", "--source-map") + $bclIncludes + @(
                "--include", "..\..\game\bdl\heroes.bdl",
                "--include", "..\..\game\bdl\enemies.bdl",
                "--include", "..\..\game\bdl\game-config.bdl"
              )
              & .\target\release\blink-compiler.exe $args
              Write-Host "Compiled $filename.brl -> $filename.ir.json (with source map including BCL/BDL)"
            } else {
              # Other BRL files only get BCL files (no BDL dependencies)
              $args = @("compile", "-i", $_.FullName, "-o", "..\..\game\ir\$filename.ir.json", "--pretty", "--source-map") + $bclIncludes
              & .\target\release\blink-compiler.exe $args
              Write-Host "Compiled $filename.brl -> $filename.ir.json (with source map including BCL)"
            }
          }
          Set-Location ..\..
          Write-Host "IR files generated:"
          Get-ChildItem game\ir\*.ir.json
        shell: pwsh
      
      - name: Create demo package directory
        run: New-Item -ItemType Directory -Path demo-package -Force
        shell: pwsh
      
      - name: Copy demo HTML and JS files
        run: |
          Copy-Item game\demos\index.html demo-package\
          Copy-Item game\demos\rpg-demo.html demo-package\
          Copy-Item game\demos\blink-engine.bundle.js demo-package\
          Copy-Item game\demos\README.md demo-package\
        shell: pwsh
      
      - name: Copy game rule files from examples
        run: |
          # Copy IR files
          Copy-Item game\ir\classic-rpg.ir.json demo-package\
          
          # Copy BCL files
          Copy-Item game\bcl\warrior-skills.bcl demo-package\
          Copy-Item game\bcl\mage-skills.bcl demo-package\
          Copy-Item game\bcl\rogue-skills.bcl demo-package\
          Copy-Item game\bcl\cleric-skills.bcl demo-package\
          Copy-Item game\bcl\party-config.bcl demo-package\
        shell: pwsh
      
      - name: Create BCL ZIP file
        run: |
          Set-Location game\bcl
          Compress-Archive -Path *.bcl -DestinationPath ..\..\demo-package\party-config.bcl.zip -Force
          Set-Location ..\..
          if (-Not (Test-Path demo-package\party-config.bcl.zip)) {
            Write-Error "Error: ZIP file was not created"
            exit 1
          }
        shell: pwsh
      
      - name: List demo package contents
        run: Get-ChildItem -Path demo-package\ -Recurse
        shell: pwsh
      
      - name: Create demo package ZIP
        run: |
          Set-Location demo-package
          Compress-Archive -Path * -DestinationPath ..\blink-demo-package-windows.zip -Force
          Set-Location ..
          Get-Item blink-demo-package-windows.zip | Select-Object Name, Length
        shell: pwsh
      
      - name: Upload demo package artifact
        uses: actions/upload-artifact@v4
        with:
          name: blink-demo-package-windows
          path: demo-package/
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: blink-demo-package-windows.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # Blink Idle RPG - Demo Package Release (Windows)
            
            This release includes a ready-to-run demo package for Windows.
            
            ## Quick Start
            1. Download `blink-demo-package-windows.zip`
            2. Extract the files to a folder
            3. Serve the demos using a web server (see README.md)
            4. Open http://localhost:3000 in your browser
            
            ## Running the Demos
            
            Use a local web server to run the demos:
            
            ```cmd
            cd demo-package
            npx serve .
            ```
            
            Or use Python:
            
            ```cmd
            cd demo-package
            python -m http.server 8000
            ```
            
            ## What's Included
            - Classic RPG demo (`rpg-demo.html`)
            - Demo launcher (`index.html`)
            - Blink engine bundle
            - Example game files (BRL, IR, BCL)
            - Complete documentation
            
            See `README.md` in the package for more details.
