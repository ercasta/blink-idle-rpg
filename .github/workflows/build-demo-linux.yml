name: Build Demo Package (Linux)

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-demo-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Build compiler
        run: |
          cd src/compiler
          cargo build --release
          echo "Compiler built successfully"
      
      - name: Compile BRL to IR
        run: |
          mkdir -p examples/ir
          cd src/compiler
          # Compile simple-combat.brl
          ./target/release/blink-compiler compile -i ../../examples/brl/simple-combat.brl -o ../../examples/ir/simple-combat.ir.json --pretty
          # Compile simple-clicker.brl
          ./target/release/blink-compiler compile -i ../../examples/brl/simple-clicker.brl -o ../../examples/ir/simple-clicker.ir.json --pretty
          # Compile classic-rpg.brl
          ./target/release/blink-compiler compile -i ../../examples/brl/classic-rpg.brl -o ../../examples/ir/classic-rpg.ir.json --pretty
          cd ../..
          echo "IR files generated:"
          ls -la examples/ir/*.ir.json
      
      - name: Create demo package directory
        run: mkdir -p demo-package
      
      - name: Copy demo HTML and JS files
        run: |
          cp examples/demos/index.html demo-package/
          cp examples/demos/combat-demo.html demo-package/
          cp examples/demos/rpg-demo.html demo-package/
          cp examples/demos/blink-engine.bundle.js demo-package/
          cp examples/demos/README.md demo-package/
      
      - name: Copy game rule files from examples
        run: |
          # Copy BRL files
          cp examples/brl/simple-combat.brl demo-package/
          cp examples/brl/simple-clicker.brl demo-package/
          
          # Copy IR files
          cp examples/ir/simple-combat.ir.json demo-package/
          cp examples/ir/simple-clicker.ir.json demo-package/
          cp examples/ir/classic-rpg.ir.json demo-package/
          
          # Copy BCL files
          cp examples/bcl/warrior-skills.bcl demo-package/
          cp examples/bcl/mage-skills.bcl demo-package/
          cp examples/bcl/rogue-skills.bcl demo-package/
          cp examples/bcl/cleric-skills.bcl demo-package/
          cp examples/bcl/party-config.bcl demo-package/
      
      - name: Create BCL ZIP file
        run: |
          set -e
          cd examples/bcl
          zip ../../demo-package/party-config.bcl.zip *.bcl
          if [ ! -f ../../demo-package/party-config.bcl.zip ]; then
            echo "Error: ZIP file was not created"
            exit 1
          fi
      
      - name: List demo package contents
        run: ls -la demo-package/
      
      - name: Create demo package ZIP
        run: |
          cd demo-package
          zip -r ../blink-demo-package-linux.zip .
          cd ..
          ls -lh blink-demo-package-linux.zip
      
      - name: Upload demo package artifact
        uses: actions/upload-artifact@v4
        with:
          name: blink-demo-package-linux
          path: demo-package/
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: blink-demo-package-linux.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # Blink Idle RPG - Demo Package Release (Linux)
            
            This release includes a ready-to-run demo package for Linux.
            
            ## Quick Start
            1. Download `blink-demo-package-linux.zip`
            2. Extract the files to a folder
            3. Serve the demos using a web server (see README.md)
            4. Open http://localhost:3000 in your browser
            
            ## Running the Demos
            
            Use a local web server to run the demos:
            
            ```bash
            cd demo-package
            npx serve .
            ```
            
            Or use Python:
            
            ```bash
            cd demo-package
            python -m http.server 8000
            ```
            
            ## What's Included
            - Interactive combat demo (`combat-demo.html`)
            - Classic RPG demo (`rpg-demo.html`)
            - Demo launcher (`index.html`)
            - Blink engine bundle
            - Example game files (BRL, IR, BCL)
            - Complete documentation
            
            See `README.md` in the package for more details.
