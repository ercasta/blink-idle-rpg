<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Async Engine Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .counter {
      font-size: 48px;
      font-weight: bold;
      text-align: center;
      color: #007bff;
      margin: 20px 0;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #e9ecef;
    }
  </style>
</head>
<body>
  <h1>ðŸ§ª Async Engine Test</h1>
  
  <div class="test-card">
    <h2>UI Responsiveness Test</h2>
    <p>This test verifies that the engine processes events asynchronously without blocking the UI.</p>
    
    <div class="status info" id="status">Ready to test</div>
    
    <div class="counter" id="counter">0</div>
    
    <div>
      <button id="startBtn" onclick="startTest()">Start Test</button>
      <button id="stopBtn" onclick="stopTest()" disabled>Stop Test</button>
      <button id="interactionBtn" onclick="testInteraction()">Test UI Interaction</button>
    </div>
    
    <h3>Interaction Counter</h3>
    <p>Click "Test UI Interaction" while the simulation is running. If the UI is responsive, this counter will increment immediately:</p>
    <div class="counter" id="interactionCounter">0</div>
    
    <h3>Event Log</h3>
    <div class="log" id="log"></div>
  </div>

  <script src="blink-engine.bundle.js"></script>
  <script>
    let game = null;
    let interactionCount = 0;
    let startTime = 0;
    
    const statusEl = document.getElementById('status');
    const counterEl = document.getElementById('counter');
    const interactionCounterEl = document.getElementById('interactionCounter');
    const logEl = document.getElementById('log');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    
    function log(message) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const time = game ? game.getTime().toFixed(2) : '0.00';
      entry.textContent = `[${time}s] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    function updateStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
    
    function testInteraction() {
      interactionCount++;
      interactionCounterEl.textContent = interactionCount;
      log(`UI interaction ${interactionCount} - UI is responsive!`);
    }
    
    async function startTest() {
      startBtn.disabled = true;
      stopBtn.disabled = false;
      interactionCount = 0;
      interactionCounterEl.textContent = interactionCount;
      logEl.innerHTML = '';
      
      log('Creating game instance...');
      
      // Create a test IR with rapid event generation
      const testIR = {
        version: "1.0",
        module: "async_test",
        components: [
          {
            id: 0,
            name: "Counter",
            fields: [
              { name: "value", type: "number", default: 0 }
            ]
          }
        ],
        rules: [
          {
            id: 0,
            name: "increment_counter",
            trigger: {
              type: "event",
              event: "Tick",
              bindings: {}
            },
            filter: { components: ["Counter"] },
            actions: [
              {
                type: "modify",
                entity: { type: "literal", value: 0 },
                component: "Counter",
                field: "value",
                op: "add",
                value: { type: "literal", value: 1 }
              },
              // Schedule another tick immediately to create rapid event chain
              {
                type: "schedule",
                event: "Tick",
                delay: { type: "literal", value: 0.01 },
                fields: {}
              }
            ]
          }
        ],
        functions: [],
        initial_state: {
          entities: [
            {
              id: 0,
              components: {
                Counter: { value: 0 }
              }
            }
          ]
        }
      };
      
      try {
        game = BlinkEngine.BlinkGame.createSync({
          debug: true,
          msPerFrame: 50, // Process 50ms of simulation per frame
          maxEventsPerFrame: 100
        });
        
        log('Loading test rules...');
        game.loadRulesFromObject(testIR);
        
        log('Scheduling initial event...');
        game.scheduleEvent('Tick', 0);
        
        // Subscribe to simulation events
        game.onSimulation((event) => {
          if (event.type === 'step') {
            const counter = game.getComponent(0, 'Counter');
            counterEl.textContent = counter.value;
          } else {
            log(`Simulation: ${event.type}`);
          }
        });
        
        log('Starting simulation with async processing...');
        updateStatus('Running - Try clicking "Test UI Interaction" to verify responsiveness!', 'success');
        startTime = Date.now();
        
        game.start();
        
      } catch (error) {
        log(`ERROR: ${error.message}`);
        updateStatus(`Error: ${error.message}`, 'error');
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }
    
    function stopTest() {
      if (game) {
        game.stop();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        const counter = game.getComponent(0, 'Counter');
        log(`Test completed - Final counter: ${counter.value}`);
        log(`Wall time elapsed: ${elapsed}s`);
        log(`Simulation time: ${game.getTime().toFixed(2)}s`);
        updateStatus(`Test completed! Counter reached ${counter.value}`, 'success');
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
    
    // Initial log
    log('Ready to test. Click "Start Test" to begin.');
    log('The engine now processes events in batches with async yields.');
    log('This keeps the UI responsive even under heavy load.');
  </script>
</body>
</html>
