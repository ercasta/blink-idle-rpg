{
  "version": "1.0",
  "module": "unnamed",
  "metadata": {
    "compiled_at": "2026-01-18T15:47:28Z",
    "compiler_version": "0.1.0"
  },
  "components": [
    {
      "id": 0,
      "name": "Character",
      "fields": [
        {
          "name": "name",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "class",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "level",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "experience",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "experienceToLevel",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 1,
      "name": "Health",
      "fields": [
        {
          "name": "current",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "max",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 2,
      "name": "Mana",
      "fields": [
        {
          "name": "current",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "max",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 3,
      "name": "Stats",
      "fields": [
        {
          "name": "strength",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "dexterity",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "intelligence",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "constitution",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "wisdom",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 4,
      "name": "Combat",
      "fields": [
        {
          "name": "damage",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "defense",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "attackSpeed",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "critChance",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "critMultiplier",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 5,
      "name": "Target",
      "fields": [
        {
          "name": "entity",
          "type": {
            "type": "entity"
          }
        }
      ]
    },
    {
      "id": 6,
      "name": "Team",
      "fields": [
        {
          "name": "id",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "isPlayer",
          "type": {
            "type": "boolean"
          }
        }
      ]
    },
    {
      "id": 7,
      "name": "Enemy",
      "fields": [
        {
          "name": "tier",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "isBoss",
          "type": {
            "type": "boolean"
          }
        },
        {
          "name": "expReward",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 8,
      "name": "Skills",
      "fields": [
        {
          "name": "skill1",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "skill2",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "skill3",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "skill4",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "skillPoints",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 9,
      "name": "Buffs",
      "fields": [
        {
          "name": "damageBonus",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "defenseBonus",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "hasteBonus",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "shieldAmount",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "regenAmount",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 10,
      "name": "GameState",
      "fields": [
        {
          "name": "currentWave",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "enemiesDefeated",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "playerDeaths",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "bossDefeated",
          "type": {
            "type": "boolean"
          }
        },
        {
          "name": "gameOver",
          "type": {
            "type": "boolean"
          }
        },
        {
          "name": "victory",
          "type": {
            "type": "boolean"
          }
        },
        {
          "name": "retargetingActive",
          "type": {
            "type": "boolean"
          }
        }
      ]
    },
    {
      "id": 11,
      "name": "RunStats",
      "fields": [
        {
          "name": "simulationTime",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "retreatCount",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "retreatPenalty",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "deathPenalty",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "totalTime",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "canFlee",
          "type": {
            "type": "boolean"
          }
        },
        {
          "name": "lastFleeTime",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 12,
      "name": "FleeConfig",
      "fields": [
        {
          "name": "retreatTimePenalty",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "deathTimePenaltyMultiplier",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "fleeCooldown",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 13,
      "name": "SkillCooldown",
      "fields": [
        {
          "name": "skill1Cooldown",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "skill2Cooldown",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "skill3Cooldown",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "skill4Cooldown",
          "type": {
            "type": "number"
          }
        }
      ]
    },
    {
      "id": 14,
      "name": "ChoiceContext",
      "fields": [
        {
          "name": "pendingChoice",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "options",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "chosen",
          "type": {
            "type": "string"
          }
        }
      ]
    },
    {
      "id": 15,
      "name": "HeroInfo",
      "fields": [
        {
          "name": "id",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "description",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "difficulty",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "role",
          "type": {
            "type": "string"
          }
        },
        {
          "name": "playstyle",
          "type": {
            "type": "string"
          }
        }
      ]
    },
    {
      "id": 16,
      "name": "SpawnConfig",
      "fields": [
        {
          "name": "bossEveryKills",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "tierProgressionKills",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "maxTier",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "healthScaleRate",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "damageScaleRate",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "initialEnemyCount",
          "type": {
            "type": "number"
          }
        }
      ]
    }
  ],
  "rules": [
    {
      "id": 0,
      "name": "attack_rule",
      "trigger": {
        "type": "event",
        "event": "DoAttack"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "binary",
              "op": "neq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Target",
                "field": "entity"
              },
              "right": {
                "type": "literal",
                "value": null
              }
            },
            "right": {
              "type": "binary",
              "op": "gt",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Health",
                "field": "current"
              },
              "right": {
                "type": "literal",
                "value": 0.0
              }
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "target"
              },
              "component": "Health",
              "field": "current",
              "op": "subtract",
              "value": {
                "type": "var",
                "name": "damage"
              }
            },
            {
              "type": "schedule",
              "event": "AfterAttack",
              "fields": {
                "attacker": {
                  "type": "var",
                  "name": "id"
                },
                "target": {
                  "type": "var",
                  "name": "id"
                }
              }
            },
            {
              "type": "schedule",
              "event": "DoAttack",
              "delay": {
                "type": "var",
                "name": "delay"
              },
              "fields": {
                "source": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 1,
      "name": "death_check",
      "trigger": {
        "type": "event",
        "event": "AfterAttack"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "lte",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Health",
              "field": "current"
            },
            "right": {
              "type": "literal",
              "value": 0.0
            }
          },
          "then_actions": [
            {
              "type": "schedule",
              "event": "Death",
              "fields": {
                "target": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 2,
      "name": "enemy_death_handler",
      "trigger": {
        "type": "event",
        "event": "Death"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "binary",
              "op": "gt",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Enemy",
                "field": "tier"
              },
              "right": {
                "type": "literal",
                "value": 0.0
              }
            },
            "right": {
              "type": "binary",
              "op": "lte",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Health",
                "field": "current"
              },
              "right": {
                "type": "literal",
                "value": 0.0
              }
            }
          },
          "then_actions": [
            {
              "type": "schedule",
              "event": "EnemyDefeated",
              "fields": {
                "enemy": {
                  "type": "var",
                  "name": "id"
                },
                "expReward": {
                  "type": "field",
                  "entity": "entity",
                  "component": "Enemy",
                  "field": "expReward"
                },
                "isBoss": {
                  "type": "field",
                  "entity": "entity",
                  "component": "Enemy",
                  "field": "isBoss"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 3,
      "name": "player_death_handler",
      "trigger": {
        "type": "event",
        "event": "Death"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Team",
              "field": "isPlayer"
            },
            "right": {
              "type": "binary",
              "op": "lte",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Health",
                "field": "current"
              },
              "right": {
                "type": "literal",
                "value": 0.0
              }
            }
          },
          "then_actions": [
            {
              "type": "schedule",
              "event": "PlayerDefeated",
              "fields": {
                "player": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 4,
      "name": "grant_experience",
      "trigger": {
        "type": "event",
        "event": "EnemyDefeated"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "field",
            "entity": "entity",
            "component": "Team",
            "field": "isPlayer"
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Character",
              "field": "experience",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 50.0
              }
            },
            {
              "type": "schedule",
              "event": "CheckLevelUp",
              "fields": {
                "source": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 5,
      "name": "level_up_check",
      "trigger": {
        "type": "event",
        "event": "CheckLevelUp"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "gte",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Character",
              "field": "experience"
            },
            "right": {
              "type": "field",
              "entity": "entity",
              "component": "Character",
              "field": "experienceToLevel"
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Character",
              "field": "level",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 1.0
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Character",
              "field": "experience",
              "op": "subtract",
              "value": {
                "type": "field",
                "entity": "entity",
                "component": "Character",
                "field": "experienceToLevel"
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Character",
              "field": "experienceToLevel",
              "op": "multiply",
              "value": {
                "type": "literal",
                "value": 1.5
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Skills",
              "field": "skillPoints",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 1.0
              }
            },
            {
              "type": "schedule",
              "event": "LevelUp",
              "fields": {
                "source": {
                  "type": "var",
                  "name": "id"
                }
              }
            },
            {
              "type": "schedule",
              "event": "SkillChoice",
              "fields": {
                "source": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 6,
      "name": "level_up_stats",
      "trigger": {
        "type": "event",
        "event": "LevelUp"
      },
      "actions": [
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "Health",
          "field": "max",
          "op": "add",
          "value": {
            "type": "literal",
            "value": 10.0
          }
        },
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "Health",
          "field": "current",
          "op": "add",
          "value": {
            "type": "literal",
            "value": 10.0
          }
        },
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "Combat",
          "field": "damage",
          "op": "add",
          "value": {
            "type": "literal",
            "value": 2.0
          }
        },
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "Combat",
          "field": "defense",
          "op": "add",
          "value": {
            "type": "literal",
            "value": 1.0
          }
        }
      ]
    },
    {
      "id": 7,
      "name": "boss_defeated_victory",
      "trigger": {
        "type": "event",
        "event": "EnemyDefeated"
      },
      "actions": [
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "GameState",
          "field": "enemiesDefeated",
          "op": "add",
          "value": {
            "type": "literal",
            "value": 1.0
          }
        },
        {
          "type": "schedule",
          "event": "CheckVictory"
        }
      ]
    },
    {
      "id": 8,
      "name": "use_skill_power_strike",
      "trigger": {
        "type": "event",
        "event": "UseSkill"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "eq",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Skills",
              "field": "skill1"
            },
            "right": {
              "type": "literal",
              "value": "power_strike"
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Buffs",
              "field": "damageBonus",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 5.0
              }
            }
          ]
        }
      ]
    },
    {
      "id": 9,
      "name": "use_skill_fireball",
      "trigger": {
        "type": "event",
        "event": "UseSkill"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "binary",
              "op": "eq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Skills",
                "field": "skill1"
              },
              "right": {
                "type": "literal",
                "value": "fireball"
              }
            },
            "right": {
              "type": "binary",
              "op": "gte",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Mana",
                "field": "current"
              },
              "right": {
                "type": "literal",
                "value": 20.0
              }
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Mana",
              "field": "current",
              "op": "subtract",
              "value": {
                "type": "literal",
                "value": 20.0
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Buffs",
              "field": "damageBonus",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 15.0
              }
            }
          ]
        }
      ]
    },
    {
      "id": 10,
      "name": "use_skill_heal",
      "trigger": {
        "type": "event",
        "event": "UseSkill"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "binary",
              "op": "eq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Skills",
                "field": "skill1"
              },
              "right": {
                "type": "literal",
                "value": "heal"
              }
            },
            "right": {
              "type": "binary",
              "op": "gte",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Mana",
                "field": "current"
              },
              "right": {
                "type": "literal",
                "value": 15.0
              }
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Mana",
              "field": "current",
              "op": "subtract",
              "value": {
                "type": "literal",
                "value": 15.0
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Health",
              "field": "current",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 30.0
              }
            }
          ]
        }
      ]
    },
    {
      "id": 11,
      "name": "use_skill_backstab",
      "trigger": {
        "type": "event",
        "event": "UseSkill"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "eq",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Skills",
              "field": "skill1"
            },
            "right": {
              "type": "literal",
              "value": "backstab"
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Combat",
              "field": "critChance",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 0.25
              }
            }
          ]
        }
      ]
    },
    {
      "id": 12,
      "name": "mana_regen",
      "trigger": {
        "type": "event",
        "event": "ManaRegen"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "gt",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Health",
              "field": "current"
            },
            "right": {
              "type": "literal",
              "value": 0.0
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Mana",
              "field": "current",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 5.0
              }
            },
            {
              "type": "schedule",
              "event": "ManaRegen",
              "delay": {
                "type": "literal",
                "value": 2.0
              },
              "fields": {
                "source": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 13,
      "name": "spawn_next_enemy",
      "trigger": {
        "type": "event",
        "event": "SpawnEnemy"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "binary",
              "op": "eq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "GameState",
                "field": "bossDefeated"
              },
              "right": {
                "type": "literal",
                "value": false
              }
            },
            "right": {
              "type": "binary",
              "op": "eq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "GameState",
                "field": "gameOver"
              },
              "right": {
                "type": "literal",
                "value": false
              }
            }
          },
          "then_actions": [
            {
              "type": "conditional",
              "condition": {
                "type": "binary",
                "op": "or",
                "left": {
                  "type": "binary",
                  "op": "lt",
                  "left": {
                    "type": "field",
                    "entity": "entity",
                    "component": "GameState",
                    "field": "currentWave"
                  },
                  "right": {
                    "type": "literal",
                    "value": 4.0
                  }
                },
                "right": {
                  "type": "binary",
                  "op": "gte",
                  "left": {
                    "type": "field",
                    "entity": "entity",
                    "component": "GameState",
                    "field": "enemiesDefeated"
                  },
                  "right": {
                    "type": "literal",
                    "value": 2000.0
                  }
                }
              },
              "then_actions": [
                {
                  "type": "modify",
                  "entity": {
                    "type": "var",
                    "name": "entity"
                  },
                  "component": "GameState",
                  "field": "currentWave",
                  "op": "add",
                  "value": {
                    "type": "literal",
                    "value": 1.0
                  }
                },
                {
                  "type": "schedule",
                  "event": "EnemySpawned",
                  "fields": {
                    "wave": {
                      "type": "field",
                      "entity": "entity",
                      "component": "GameState",
                      "field": "currentWave"
                    }
                  }
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "id": 14,
      "name": "count_player_death",
      "trigger": {
        "type": "event",
        "event": "PlayerDefeated"
      },
      "actions": [
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "GameState",
          "field": "playerDeaths",
          "op": "add",
          "value": {
            "type": "literal",
            "value": 1.0
          }
        }
      ]
    },
    {
      "id": 15,
      "name": "apply_death_penalty",
      "trigger": {
        "type": "event",
        "event": "PlayerDefeated"
      },
      "actions": [
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "RunStats",
          "field": "deathPenalty",
          "op": "add",
          "value": {
            "type": "binary",
            "op": "multiply",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "FleeConfig",
              "field": "retreatTimePenalty"
            },
            "right": {
              "type": "field",
              "entity": "entity",
              "component": "FleeConfig",
              "field": "deathTimePenaltyMultiplier"
            }
          }
        },
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "RunStats",
          "field": "totalTime",
          "op": "set",
          "value": {
            "type": "binary",
            "op": "add",
            "left": {
              "type": "binary",
              "op": "add",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "RunStats",
                "field": "simulationTime"
              },
              "right": {
                "type": "field",
                "entity": "entity",
                "component": "RunStats",
                "field": "retreatPenalty"
              }
            },
            "right": {
              "type": "field",
              "entity": "entity",
              "component": "RunStats",
              "field": "deathPenalty"
            }
          }
        },
        {
          "type": "schedule",
          "event": "UpdateRunStats"
        }
      ]
    },
    {
      "id": 16,
      "name": "game_over_check",
      "trigger": {
        "type": "event",
        "event": "PlayerDefeated"
      },
      "actions": [
        {
          "type": "modify",
          "entity": {
            "type": "var",
            "name": "entity"
          },
          "component": "GameState",
          "field": "gameOver",
          "op": "set",
          "value": {
            "type": "literal",
            "value": true
          }
        },
        {
          "type": "schedule",
          "event": "GameOver",
          "fields": {
            "victory": {
              "type": "literal",
              "value": false
            }
          }
        }
      ]
    },
    {
      "id": 17,
      "name": "victory_check",
      "trigger": {
        "type": "event",
        "event": "CheckVictory"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "gte",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "GameState",
              "field": "enemiesDefeated"
            },
            "right": {
              "type": "literal",
              "value": 5.0
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "GameState",
              "field": "bossDefeated",
              "op": "set",
              "value": {
                "type": "literal",
                "value": true
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "GameState",
              "field": "victory",
              "op": "set",
              "value": {
                "type": "literal",
                "value": true
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "GameState",
              "field": "gameOver",
              "op": "set",
              "value": {
                "type": "literal",
                "value": true
              }
            },
            {
              "type": "schedule",
              "event": "GameOver",
              "fields": {
                "victory": {
                  "type": "literal",
                  "value": true
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 18,
      "name": "acquire_skill",
      "trigger": {
        "type": "event",
        "event": "AcquireSkill"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "gt",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Skills",
              "field": "skillPoints"
            },
            "right": {
              "type": "literal",
              "value": 0.0
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Skills",
              "field": "skillPoints",
              "op": "subtract",
              "value": {
                "type": "literal",
                "value": 1.0
              }
            },
            {
              "type": "schedule",
              "event": "SkillAcquired",
              "fields": {
                "character": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 19,
      "name": "flee_battle",
      "trigger": {
        "type": "event",
        "event": "FleeFromBattle"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "gte",
            "left": {
              "type": "var",
              "name": "timeSinceFlee"
            },
            "right": {
              "type": "field",
              "entity": "entity",
              "component": "FleeConfig",
              "field": "fleeCooldown"
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "RunStats",
              "field": "retreatCount",
              "op": "add",
              "value": {
                "type": "literal",
                "value": 1.0
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "RunStats",
              "field": "retreatPenalty",
              "op": "add",
              "value": {
                "type": "field",
                "entity": "entity",
                "component": "FleeConfig",
                "field": "retreatTimePenalty"
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "RunStats",
              "field": "lastFleeTime",
              "op": "set",
              "value": {
                "type": "field",
                "entity": "entity",
                "component": "RunStats",
                "field": "simulationTime"
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "RunStats",
              "field": "canFlee",
              "op": "set",
              "value": {
                "type": "literal",
                "value": false
              }
            },
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "RunStats",
              "field": "totalTime",
              "op": "set",
              "value": {
                "type": "binary",
                "op": "add",
                "left": {
                  "type": "binary",
                  "op": "add",
                  "left": {
                    "type": "field",
                    "entity": "entity",
                    "component": "RunStats",
                    "field": "simulationTime"
                  },
                  "right": {
                    "type": "field",
                    "entity": "entity",
                    "component": "RunStats",
                    "field": "retreatPenalty"
                  }
                },
                "right": {
                  "type": "field",
                  "entity": "entity",
                  "component": "RunStats",
                  "field": "deathPenalty"
                }
              }
            },
            {
              "type": "schedule",
              "event": "DespawnAllEnemies"
            },
            {
              "type": "schedule",
              "event": "SpawnEnemyWave",
              "delay": {
                "type": "literal",
                "value": 0.5
              }
            },
            {
              "type": "schedule",
              "event": "UpdateRunStats"
            }
          ]
        }
      ]
    },
    {
      "id": 20,
      "name": "despawn_enemies",
      "trigger": {
        "type": "event",
        "event": "DespawnAllEnemies"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "gt",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "Enemy",
              "field": "tier"
            },
            "right": {
              "type": "literal",
              "value": 0.0
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "Health",
              "field": "current",
              "op": "set",
              "value": {
                "type": "literal",
                "value": 0.0
              }
            },
            {
              "type": "schedule",
              "event": "RemoveEntity",
              "fields": {
                "target": {
                  "type": "var",
                  "name": "id"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": 21,
      "name": "update_flee_cooldown",
      "trigger": {
        "type": "event",
        "event": "UpdateRunStats"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "gte",
            "left": {
              "type": "var",
              "name": "timeSinceFlee"
            },
            "right": {
              "type": "field",
              "entity": "entity",
              "component": "FleeConfig",
              "field": "fleeCooldown"
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "RunStats",
              "field": "canFlee",
              "op": "set",
              "value": {
                "type": "literal",
                "value": true
              }
            }
          ]
        }
      ]
    },
    {
      "id": 22,
      "name": "complete_run",
      "trigger": {
        "type": "event",
        "event": "GameOver"
      },
      "actions": [
        {
          "type": "schedule",
          "event": "SaveRunToLeaderboard",
          "fields": {
            "completionTime": {
              "type": "field",
              "entity": "entity",
              "component": "RunStats",
              "field": "totalTime"
            },
            "enemiesDefeated": {
              "type": "field",
              "entity": "entity",
              "component": "GameState",
              "field": "enemiesDefeated"
            },
            "playerDeaths": {
              "type": "field",
              "entity": "entity",
              "component": "GameState",
              "field": "playerDeaths"
            },
            "retreats": {
              "type": "field",
              "entity": "entity",
              "component": "RunStats",
              "field": "retreatCount"
            },
            "retreatPenalty": {
              "type": "field",
              "entity": "entity",
              "component": "RunStats",
              "field": "retreatPenalty"
            },
            "deathPenalty": {
              "type": "field",
              "entity": "entity",
              "component": "RunStats",
              "field": "deathPenalty"
            },
            "victory": {
              "type": "field",
              "entity": "entity",
              "component": "GameState",
              "field": "victory"
            }
          }
        }
      ]
    },
    {
      "id": 23,
      "name": "start_global_retargeting",
      "trigger": {
        "type": "event",
        "event": "EnemySpawned"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "binary",
              "op": "eq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "GameState",
                "field": "currentWave"
              },
              "right": {
                "type": "literal",
                "value": 1.0
              }
            },
            "right": {
              "type": "binary",
              "op": "eq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "GameState",
                "field": "retargetingActive"
              },
              "right": {
                "type": "literal",
                "value": false
              }
            }
          },
          "then_actions": [
            {
              "type": "modify",
              "entity": {
                "type": "var",
                "name": "entity"
              },
              "component": "GameState",
              "field": "retargetingActive",
              "op": "set",
              "value": {
                "type": "literal",
                "value": true
              }
            },
            {
              "type": "schedule",
              "event": "CheckAllTargets",
              "delay": {
                "type": "literal",
                "value": 2.0
              }
            }
          ]
        }
      ]
    },
    {
      "id": 24,
      "name": "check_entity_target",
      "trigger": {
        "type": "event",
        "event": "CheckAllTargets"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "binary",
              "op": "gt",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Health",
                "field": "current"
              },
              "right": {
                "type": "literal",
                "value": 0.0
              }
            },
            "right": {
              "type": "binary",
              "op": "neq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "Target",
                "field": "entity"
              },
              "right": {
                "type": "literal",
                "value": null
              }
            }
          },
          "then_actions": [
            {
              "type": "conditional",
              "condition": {
                "type": "binary",
                "op": "lte",
                "left": {
                  "type": "field",
                  "entity": "target",
                  "component": "Health",
                  "field": "current"
                },
                "right": {
                  "type": "literal",
                  "value": 0.0
                }
              },
              "then_actions": [
                {
                  "type": "modify",
                  "entity": {
                    "type": "var",
                    "name": "entity"
                  },
                  "component": "Target",
                  "field": "entity",
                  "op": "set",
                  "value": {
                    "type": "literal",
                    "value": null
                  }
                },
                {
                  "type": "schedule",
                  "event": "FindNewTarget",
                  "fields": {
                    "seeker": {
                      "type": "var",
                      "name": "id"
                    }
                  }
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "id": 25,
      "name": "reschedule_retargeting",
      "trigger": {
        "type": "event",
        "event": "CheckAllTargets"
      },
      "actions": [
        {
          "type": "conditional",
          "condition": {
            "type": "binary",
            "op": "and",
            "left": {
              "type": "field",
              "entity": "entity",
              "component": "GameState",
              "field": "retargetingActive"
            },
            "right": {
              "type": "binary",
              "op": "eq",
              "left": {
                "type": "field",
                "entity": "entity",
                "component": "GameState",
                "field": "gameOver"
              },
              "right": {
                "type": "literal",
                "value": false
              }
            }
          },
          "then_actions": [
            {
              "type": "schedule",
              "event": "CheckAllTargets",
              "delay": {
                "type": "literal",
                "value": 2.0
              }
            }
          ]
        }
      ]
    }
  ],
  "functions": [
    {
      "id": 0,
      "name": "calculate_damage",
      "params": [
        {
          "name": "base",
          "type": {
            "type": "number"
          }
        },
        {
          "name": "bonus",
          "type": {
            "type": "number"
          }
        }
      ],
      "return_type": {
        "type": "number"
      },
      "body": {
        "type": "binary",
        "op": "add",
        "left": {
          "type": "var",
          "name": "base"
        },
        "right": {
          "type": "var",
          "name": "bonus"
        }
      }
    },
    {
      "id": 1,
      "name": "calculate_exp_for_level",
      "params": [
        {
          "name": "level",
          "type": {
            "type": "number"
          }
        }
      ],
      "return_type": {
        "type": "number"
      },
      "body": {
        "type": "binary",
        "op": "multiply",
        "left": {
          "type": "literal",
          "value": 100.0
        },
        "right": {
          "type": "var",
          "name": "level"
        }
      }
    }
  ],
  "trackers": [
    {
      "id": 0,
      "component": "Health",
      "event": "DoAttack"
    },
    {
      "id": 1,
      "component": "Character",
      "event": "DoAttack"
    },
    {
      "id": 2,
      "component": "Health",
      "event": "AfterAttack"
    },
    {
      "id": 3,
      "component": "Health",
      "event": "Death"
    },
    {
      "id": 4,
      "component": "Character",
      "event": "Death"
    },
    {
      "id": 5,
      "component": "Character",
      "event": "LevelUp"
    },
    {
      "id": 6,
      "component": "Skills",
      "event": "LevelUp"
    },
    {
      "id": 7,
      "component": "GameState",
      "event": "EnemyDefeated"
    },
    {
      "id": 8,
      "component": "GameState",
      "event": "GameOver"
    },
    {
      "id": 9,
      "component": "Enemy",
      "event": "EnemySpawned"
    },
    {
      "id": 10,
      "component": "Mana",
      "event": "UseSkill"
    },
    {
      "id": 11,
      "component": "Skills",
      "event": "SkillAcquired"
    },
    {
      "id": 12,
      "component": "ChoiceContext",
      "event": "SkillChoice"
    },
    {
      "id": 13,
      "component": "GameState",
      "event": "PlayerDefeated"
    },
    {
      "id": 14,
      "component": "RunStats",
      "event": "UpdateRunStats"
    },
    {
      "id": 15,
      "component": "RunStats",
      "event": "FleeFromBattle"
    },
    {
      "id": 16,
      "component": "GameState",
      "event": "SaveRunToLeaderboard"
    }
  ],
  "source_map": {
    "files": [
      {
        "path": "../../game/brl/classic-rpg.brl",
        "content": "// Classic RPG System\n// A comprehensive RPG with traditional classes, skill trees, and boss battles\n\n// Character information with class and level progression\ncomponent Character {\n    name: string\n    class: string\n    level: integer\n    experience: integer\n    experienceToLevel: integer\n}\n\n// Health component\ncomponent Health {\n    current: integer\n    max: integer\n}\n\n// Mana component for spell casting\ncomponent Mana {\n    current: integer\n    max: integer\n}\n\n// Character stats\ncomponent Stats {\n    strength: integer\n    dexterity: integer\n    intelligence: integer\n    constitution: integer\n    wisdom: integer\n}\n\n// Combat stats\ncomponent Combat {\n    damage: integer\n    defense: integer\n    attackSpeed: float\n    critChance: float\n    critMultiplier: float\n}\n\n// Current attack target\ncomponent Target {\n    entity: id?\n}\n\n// Team affiliation\ncomponent Team {\n    id: string\n    isPlayer: boolean\n}\n\n// Enemy information\ncomponent Enemy {\n    tier: integer\n    isBoss: boolean\n    expReward: integer\n}\n\n// Character skills\ncomponent Skills {\n    skill1: string\n    skill2: string\n    skill3: string\n    skill4: string\n    skillPoints: integer\n}\n\n// Active buffs\ncomponent Buffs {\n    damageBonus: integer\n    defenseBonus: integer\n    hasteBonus: float\n    shieldAmount: integer\n    regenAmount: integer\n}\n\n// Game state tracking\ncomponent GameState {\n    currentWave: integer\n    enemiesDefeated: integer\n    playerDeaths: integer\n    bossDefeated: boolean\n    gameOver: boolean\n    victory: boolean\n    retargetingActive: boolean\n}\n\n// Run tracking for leaderboard\ncomponent RunStats {\n    simulationTime: float\n    retreatCount: integer\n    retreatPenalty: float\n    deathPenalty: float\n    totalTime: float\n    canFlee: boolean\n    lastFleeTime: float\n}\n\n// Flee constants (defined as component for easy tuning)\ncomponent FleeConfig {\n    retreatTimePenalty: float      // 10 seconds\n    deathTimePenaltyMultiplier: float  // 5x = 50 seconds\n    fleeCooldown: float            // 5 seconds between flees\n}\n\n// Skill cooldown tracking\ncomponent SkillCooldown {\n    skill1Cooldown: float\n    skill2Cooldown: float\n    skill3Cooldown: float\n    skill4Cooldown: float\n}\n\n// Choice context for player decisions\ncomponent ChoiceContext {\n    pendingChoice: string\n    options: string\n    chosen: string\n}\n\n// Hero information for party selection UI (used by BDL)\ncomponent HeroInfo {\n    id: string\n    description: string\n    difficulty: string\n    role: string\n    playstyle: string\n}\n\n// Spawn configuration (used by BDL)\ncomponent SpawnConfig {\n    bossEveryKills: integer\n    tierProgressionKills: integer\n    maxTier: integer\n    healthScaleRate: integer\n    damageScaleRate: integer\n    initialEnemyCount: integer\n}\n\n// Helper function to calculate damage\nfn calculate_damage(base: float, bonus: float): float {\n    return base + bonus\n}\n\n// Helper function to calculate experience for level\nfn calculate_exp_for_level(level: float): float {\n    return 100 * level\n}\n\n// Main attack rule: apply damage and schedule next attack\nrule attack_rule on DoAttack {\n    if entity.Target.entity != null && entity.Health.current > 0 {\n        let target = entity.Target.entity\n        let damage = entity.Combat.damage + entity.Buffs.damageBonus\n        \n        // Apply damage to target\n        target.Health.current -= damage\n        \n        // Emit after attack event\n        schedule AfterAttack {\n            attacker: entity.id\n            target: target.id\n        }\n        \n        // Schedule next attack\n        let delay = 1 / (entity.Combat.attackSpeed + entity.Buffs.hasteBonus)\n        schedule [delay: delay] DoAttack {\n            source: entity.id\n        }\n    }\n}\n\n// Death check: emit Death event when health drops to zero\nrule death_check on AfterAttack {\n    if entity.Health.current <= 0 {\n        schedule Death {\n            target: entity.id\n        }\n    }\n}\n\n// Enemy death handler\nrule enemy_death_handler on Death {\n    if entity.Enemy.tier > 0 && entity.Health.current <= 0 {\n        schedule EnemyDefeated {\n            enemy: entity.id\n            expReward: entity.Enemy.expReward\n            isBoss: entity.Enemy.isBoss\n        }\n    }\n}\n\n// Player death handler\nrule player_death_handler on Death {\n    if entity.Team.isPlayer && entity.Health.current <= 0 {\n        schedule PlayerDefeated {\n            player: entity.id\n        }\n    }\n}\n\n// Grant experience to players when enemy defeated\nrule grant_experience on EnemyDefeated {\n    if entity.Team.isPlayer {\n        entity.Character.experience += 50\n        schedule CheckLevelUp {\n            source: entity.id\n        }\n    }\n}\n\n// Level up check\nrule level_up_check on CheckLevelUp {\n    if entity.Character.experience >= entity.Character.experienceToLevel {\n        entity.Character.level += 1\n        entity.Character.experience -= entity.Character.experienceToLevel\n        entity.Character.experienceToLevel *= 1.5\n        entity.Skills.skillPoints += 1\n        \n        schedule LevelUp {\n            source: entity.id\n        }\n        \n        schedule SkillChoice {\n            source: entity.id\n        }\n    }\n}\n\n// Level up stat increases\nrule level_up_stats on LevelUp {\n    entity.Health.max += 10\n    entity.Health.current += 10\n    entity.Combat.damage += 2\n    entity.Combat.defense += 1\n}\n\n// Track enemy defeats and check victory\nrule boss_defeated_victory on EnemyDefeated {\n    entity.GameState.enemiesDefeated += 1\n    schedule CheckVictory {\n    }\n}\n\n// Power strike skill\nrule use_skill_power_strike on UseSkill {\n    if entity.Skills.skill1 == \"power_strike\" {\n        entity.Buffs.damageBonus += 5\n    }\n}\n\n// Fireball skill\nrule use_skill_fireball on UseSkill {\n    if entity.Skills.skill1 == \"fireball\" && entity.Mana.current >= 20 {\n        entity.Mana.current -= 20\n        entity.Buffs.damageBonus += 15\n    }\n}\n\n// Heal skill\nrule use_skill_heal on UseSkill {\n    if entity.Skills.skill1 == \"heal\" && entity.Mana.current >= 15 {\n        entity.Mana.current -= 15\n        entity.Health.current += 30\n    }\n}\n\n// Backstab skill\nrule use_skill_backstab on UseSkill {\n    if entity.Skills.skill1 == \"backstab\" {\n        entity.Combat.critChance += 0.25\n    }\n}\n\n// Mana regeneration\nrule mana_regen on ManaRegen {\n    if entity.Health.current > 0 {\n        entity.Mana.current += 5\n        schedule [delay: 2] ManaRegen {\n            source: entity.id\n        }\n    }\n}\n\n// Spawn next enemy wave\nrule spawn_next_enemy on SpawnEnemy {\n    if entity.GameState.bossDefeated == false && entity.GameState.gameOver == false {\n        if entity.GameState.currentWave < 4 || entity.GameState.enemiesDefeated >= 2000 {\n            entity.GameState.currentWave += 1\n            schedule EnemySpawned {\n                wave: entity.GameState.currentWave\n            }\n        }\n    }\n}\n\n// Count player deaths\nrule count_player_death on PlayerDefeated {\n    entity.GameState.playerDeaths += 1\n}\n\n// Apply death penalty to run stats\nrule apply_death_penalty on PlayerDefeated {\n    entity.RunStats.deathPenalty += entity.FleeConfig.retreatTimePenalty * entity.FleeConfig.deathTimePenaltyMultiplier\n    entity.RunStats.totalTime = entity.RunStats.simulationTime + entity.RunStats.retreatPenalty + entity.RunStats.deathPenalty\n    schedule UpdateRunStats {\n    }\n}\n\n// Game over on all players dead\nrule game_over_check on PlayerDefeated {\n    // Check if all players are dead\n    // Note: This is simplified - real check would query all player entities\n    entity.GameState.gameOver = true\n    schedule GameOver {\n        victory: false\n    }\n}\n\n// Victory check\nrule victory_check on CheckVictory {\n    if entity.GameState.enemiesDefeated >= 5 {\n        entity.GameState.bossDefeated = true\n        entity.GameState.victory = true\n        entity.GameState.gameOver = true\n        schedule GameOver {\n            victory: true\n        }\n    }\n}\n\n// Acquire skill\nrule acquire_skill on AcquireSkill {\n    if entity.Skills.skillPoints > 0 {\n        entity.Skills.skillPoints -= 1\n        schedule SkillAcquired {\n            character: entity.id\n        }\n    }\n}\n\n// Flee from battle - player initiates retreat\nrule flee_battle on FleeFromBattle {\n    // Check cooldown\n    let timeSinceFlee = entity.RunStats.simulationTime - entity.RunStats.lastFleeTime\n    if timeSinceFlee >= entity.FleeConfig.fleeCooldown {\n        // Apply retreat penalty\n        entity.RunStats.retreatCount += 1\n        entity.RunStats.retreatPenalty += entity.FleeConfig.retreatTimePenalty\n        entity.RunStats.lastFleeTime = entity.RunStats.simulationTime\n        entity.RunStats.canFlee = false\n        entity.RunStats.totalTime = entity.RunStats.simulationTime + entity.RunStats.retreatPenalty + entity.RunStats.deathPenalty\n        \n        // Mark all enemies for despawn\n        schedule DespawnAllEnemies {\n        }\n        \n        // Spawn new wave after retreat\n        schedule [delay: 0.5] SpawnEnemyWave {\n        }\n        \n        schedule UpdateRunStats {\n        }\n    }\n}\n\n// Despawn all enemies on flee\nrule despawn_enemies on DespawnAllEnemies {\n    if entity.Enemy.tier > 0 {\n        // Remove enemy entity (handled by engine)\n        entity.Health.current = 0\n        schedule RemoveEntity {\n            target: entity.id\n        }\n    }\n}\n\n// Update flee cooldown timer\nrule update_flee_cooldown on UpdateRunStats {\n    let timeSinceFlee = entity.RunStats.simulationTime - entity.RunStats.lastFleeTime\n    if timeSinceFlee >= entity.FleeConfig.fleeCooldown {\n        entity.RunStats.canFlee = true\n    }\n}\n\n// Complete run and save to leaderboard\nrule complete_run on GameOver {\n    schedule SaveRunToLeaderboard {\n        completionTime: entity.RunStats.totalTime\n        enemiesDefeated: entity.GameState.enemiesDefeated\n        playerDeaths: entity.GameState.playerDeaths\n        retreats: entity.RunStats.retreatCount\n        retreatPenalty: entity.RunStats.retreatPenalty\n        deathPenalty: entity.RunStats.deathPenalty\n        victory: entity.GameState.victory\n    }\n}\n\n// Start global recurring retargeting when game begins\nrule start_global_retargeting on EnemySpawned {\n    // Only start retargeting once, when first enemy spawns\n    if entity.GameState.currentWave == 1 && entity.GameState.retargetingActive == false {\n        entity.GameState.retargetingActive = true\n        // Schedule first retargeting check in 2 seconds\n        schedule [delay: 2.0] CheckAllTargets {\n        }\n    }\n}\n\n// Check if entity needs retargeting\nrule check_entity_target on CheckAllTargets {\n    // Rule fires for each entity with Target and Health components\n    if entity.Health.current > 0 && entity.Target.entity != null {\n        let target = entity.Target.entity\n        // Check if target is dead\n        // NOTE: BRL engine should handle the case where target entity no longer exists\n        if target.Health.current <= 0 {\n            // Target is dead, need new target\n            entity.Target.entity = null\n            schedule FindNewTarget {\n                seeker: entity.id\n            }\n        }\n    }\n}\n\n// Reschedule the next retargeting check (makes it recurring)\n// REQUIRES: An entity with GameState component must exist in the game\n// This rule only fires for the GameState entity to ensure single reschedule\nrule reschedule_retargeting on CheckAllTargets {\n    // Only fire for entity with GameState component\n    if entity.GameState.retargetingActive && entity.GameState.gameOver == false {\n        // Schedule next check in 2 seconds\n        schedule [delay: 2.0] CheckAllTargets {\n        }\n    }\n}\n\n// Trackers for UI feedback\ntracker Health on DoAttack\ntracker Character on DoAttack\ntracker Health on AfterAttack\ntracker Health on Death\ntracker Character on Death\ntracker Character on LevelUp\ntracker Skills on LevelUp\ntracker GameState on EnemyDefeated\ntracker GameState on GameOver\ntracker Enemy on EnemySpawned\ntracker Mana on UseSkill\ntracker Skills on SkillAcquired\ntracker ChoiceContext on SkillChoice\ntracker GameState on PlayerDefeated\ntracker RunStats on UpdateRunStats\ntracker RunStats on FleeFromBattle\ntracker GameState on SaveRunToLeaderboard\n",
        "language": "brl"
      }
    ]
  }
}